<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arduino Code Generator AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.7.0"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        textarea, #outputCode {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
        }
        #generateButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        #status {
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Arduino Code Generator</h1>
    <div id="status">Loading model...</div>
    <textarea id="userInput" rows="4" placeholder="Describe your Arduino project (e.g., 'temperature sensor', 'LED blinking', 'motor control')..."></textarea>
    <button id="generateButton" disabled>Generate Code</button>
    <pre id="outputCode"></pre>

    <script>
        let model, vocab;

        async function loadModelAndVocab() {
            const status = document.getElementById('status');
            const generateButton = document.getElementById('generateButton');

            try {
                // Load model from GitHub Pages or your hosting
                model = await tf.loadLayersModel('https://your-domain.github.io/codegenerator/ai_model/model.json');
                
                // Fetch vocabulary
                const response = await fetch('https://your-domain.github.io/codegenerator/ai_model/vocab.json');
                vocab = await response.json();

                status.textContent = 'Model loaded successfully!';
                generateButton.disabled = false;
            } catch (error) {
                status.textContent = `Model loading failed: ${error.message}`;
                console.error("Model loading error:", error);
            }
        }

        function prepareInput(text, maxLength = 100) {
            // Enhanced tokenization
            const tokens = text.toLowerCase()
                .replace(/[^\w\s]/g, '')  // Remove punctuation
                .split(/\s+/)
                .filter(token => token.length > 0);

            // Pad or truncate to maxLength
            const paddedTokens = tokens.slice(0, maxLength);
            while (paddedTokens.length < maxLength) {
                paddedTokens.push('<PAD>');
            }

            // Convert to indices, handling unknown tokens
            return paddedTokens.map(token => 
                vocab.vocabulary.indexOf(token) !== -1 
                    ? vocab.vocabulary.indexOf(token) 
                    : vocab.vocabulary.indexOf('<PAD>')
            );
        }

        function decodeOutput(outputTensor) {
            const outputIndices = Array.from(outputTensor.argMax(-1).dataSync());
            const tokens = outputIndices
                .map(index => vocab.vocabulary[index] || '')
                .filter(token => token !== '<PAD>');
            
            // Basic template generation
            const code = tokens.join(' ');
            return `void setup() {
    // ${tokens.slice(0, 5).join(' ')} initialization
    // Add your setup code here
}

void loop() {
    // ${tokens.slice(5, 10).join(' ')} logic
    // Add your main loop code here
}`;
        }

        async function generateCode() {
            const input = document.getElementById('userInput').value;
            const status = document.getElementById('status');

            if (!input.trim()) {
                status.textContent = 'Please enter a project description';
                return;
            }

            try {
                const processedInput = prepareInput(input);
                const inputTensor = tf.tensor2d(
                    [processedInput], 
                    [1, processedInput.length]
                );

                const prediction = model.predict(inputTensor);
                const generatedCode = decodeOutput(prediction);
                
                document.getElementById('outputCode').textContent = generatedCode;
                status.textContent = 'Code generated successfully!';
            } catch (error) {
                status.textContent = `Code generation failed: ${error.message}`;
                console.error("Generation error:", error);
            }
        }

        document.getElementById('generateButton').addEventListener('click', generateCode);
        window.onload = loadModelAndVocab;
    </script>
</body>
</html>
