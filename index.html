<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arduino Code Generator AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
    <h1>Arduino Code Generator</h1>
    <textarea id="userInput" rows="4" placeholder="Describe your Arduino project..."></textarea>
    <button id="generateButton">Generate Code</button>
    <pre id="outputCode"></pre>

    <script>
        let model, vocab;

        async function loadModelAndVocab() {
            try {
                model = await tf.loadLayersModel('https://4211421036.github.io/codegenerator/ai_model/model.json');
                const response = await fetch('https://4211421036.github.io/codegenerator/ai_model/vocab.json');
                vocab = await response.json();
            } catch (error) {
                console.error("Model loading failed:", error);
            }
        }

        function prepareInput(text, maxLength = 100) {
            // Tokenize input, preserve structure
            const tokens = text.toLowerCase()
                .split(/\s+/)
                .filter(token => token.length > 0);

            // Pad or truncate to maxLength
            const paddedTokens = tokens.slice(0, maxLength);
            while (paddedTokens.length < maxLength) {
                paddedTokens.push('<PAD>');
            }

            // Convert to indices
            return paddedTokens.map(token => 
                vocab.vocabulary.indexOf(token) !== -1 
                    ? vocab.vocabulary.indexOf(token) 
                    : 0
            );
        }

        function decodeOutput(outputTensor) {
            const outputIndices = Array.from(outputTensor.argMax(-1).dataSync());
            const tokens = outputIndices
                .map(index => vocab.vocabulary[index] || '')
                .filter(token => token !== '<PAD>');

            return tokens.join(' ');
        }

        async function generateCode() {
            const input = document.getElementById('userInput').value;
            const processedInput = prepareInput(input);
            
            // Ensure tensor is 2D with correct shape
            const inputTensor = tf.tensor2d(
                [processedInput], 
                [1, processedInput.length]
            );

            try {
                const prediction = model.predict(inputTensor);
                const generatedCode = decodeOutput(prediction);
                
                document.getElementById('outputCode').textContent = generatedCode;
            } catch (error) {
                console.error("Code generation failed:", error);
            }
        }

        document.getElementById('generateButton').addEventListener('click', generateCode);
        window.onload = loadModelAndVocab;
    </script>
</body>
</html>
